"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_textract_1 = require("@aws-sdk/client-textract");
const client_s3_1 = require("@aws-sdk/client-s3");
const opensearch_1 = require("@opensearch-project/opensearch");
const uuid_1 = require("uuid");
const textractClient = new client_textract_1.TextractClient({});
const s3Client = new client_s3_1.S3Client({});
const openSearchClient = new opensearch_1.Client({
    node: process.env.COLLECTION_ENDPOINT,
    ssl: {
        rejectUnauthorized: false
    }
});
const handler = async (event, context) => {
    try {
        console.log('Processing event:', JSON.stringify(event, null, 2));
        for (const record of event.Records) {
            await processS3Record(record);
        }
    }
    catch (error) {
        console.error('Error processing event:', error);
        throw error;
    }
};
exports.handler = handler;
async function processS3Record(record) {
    const bucket = record.s3.bucket.name;
    const key = decodeURIComponent(record.s3.object.key.replace(/\+/g, ' '));
    try {
        // Start text detection
        const startResponse = await textractClient.send(new client_textract_1.StartDocumentTextDetectionCommand({
            DocumentLocation: {
                S3Object: {
                    Bucket: bucket,
                    Name: key
                }
            }
        }));
        if (!startResponse.JobId) {
            throw new Error('No JobId returned from Textract');
        }
        // Poll for completion
        const textractResult = await waitForTextractCompletion(startResponse.JobId);
        // Extract text blocks
        const extractedText = textractResult.Blocks
            ?.filter(block => block.BlockType === 'LINE')
            .map(block => block.Text)
            .join('\n') || '';
        // Get original file metadata from S3
        const s3Response = await s3Client.send(new client_s3_1.GetObjectCommand({
            Bucket: bucket,
            Key: key
        }));
        // Save to OpenSearch
        const document = {
            id: (0, uuid_1.v4)(),
            type: 'learning_module',
            content: extractedText,
            sourceFile: {
                bucket,
                key,
                lastModified: s3Response.LastModified,
                contentType: s3Response.ContentType
            },
            metadata: {
                processedAt: new Date().toISOString(),
                confidence: calculateAverageConfidence(textractResult.Blocks),
                pageCount: countPages(textractResult.Blocks)
            }
        };
        await openSearchClient.index({
            index: process.env.COLLECTION_NAME || 'fijian-translations',
            body: document,
            refresh: true
        });
        console.log(`Successfully processed and indexed document: ${key}`);
    }
    catch (error) {
        console.error(`Error processing file ${key} from bucket ${bucket}:`, error);
        throw error;
    }
}
async function waitForTextractCompletion(jobId, maxAttempts = 60) {
    let attempts = 0;
    while (attempts < maxAttempts) {
        const response = await textractClient.send(new client_textract_1.GetDocumentTextDetectionCommand({
            JobId: jobId
        }));
        if (response.JobStatus === 'SUCCEEDED') {
            return response;
        }
        if (response.JobStatus === 'FAILED') {
            throw new Error(`Textract job failed: ${response.StatusMessage}`);
        }
        // Wait 2 seconds before next attempt
        await new Promise(resolve => setTimeout(resolve, 2000));
        attempts++;
    }
    throw new Error('Textract processing timed out');
}
function calculateAverageConfidence(blocks = []) {
    const confidenceValues = blocks
        .filter((block) => typeof block.Confidence === 'number')
        .map(block => block.Confidence);
    if (confidenceValues.length === 0)
        return 0;
    const sum = confidenceValues.reduce((acc, val) => acc + val, 0);
    return Number((sum / confidenceValues.length).toFixed(2));
}
function countPages(blocks = []) {
    return new Set(blocks.map(block => block.Page)).size;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsOERBQThIO0FBQzlILGtEQUFnRTtBQUNoRSwrREFBNEU7QUFDNUUsK0JBQW9DO0FBZXBDLE1BQU0sY0FBYyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM5QyxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDbEMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLG1CQUFnQixDQUFDO0lBQzVDLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQjtJQUNyQyxHQUFHLEVBQUU7UUFDSCxrQkFBa0IsRUFBRSxLQUFLO0tBQzFCO0NBQ0YsQ0FBQyxDQUFDO0FBRUksTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQWMsRUFBRSxPQUFnQixFQUFpQixFQUFFO0lBQy9FLElBQUksQ0FBQztRQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFakUsS0FBSyxNQUFNLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDbkMsTUFBTSxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDaEMsQ0FBQztJQUNILENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRCxNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUM7QUFYVyxRQUFBLE9BQU8sV0FXbEI7QUFFRixLQUFLLFVBQVUsZUFBZSxDQUFDLE1BQXFCO0lBQ2xELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxD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SUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUN2RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbGFtYmRhL2FnZW50cy90ZXh0cmFjdC1wcm9jZXNzb3IvaGFuZGxlci50c1xyXG5pbXBvcnQgeyBTM0V2ZW50LCBDb250ZXh0LCBTM0V2ZW50UmVjb3JkIH0gZnJvbSAnYXdzLWxhbWJkYSc7XHJcbmltcG9ydCB7IFRleHRyYWN0Q2xpZW50LCBTdGFydERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQsIEdldERvY3VtZW50VGV4dERldGVjdGlvbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtdGV4dHJhY3QnO1xyXG5pbXBvcnQgeyBTM0NsaWVudCwgR2V0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XHJcbmltcG9ydCB7IENsaWVudCBhcyBPcGVuU2VhcmNoQ2xpZW50IH0gZnJvbSAnQG9wZW5zZWFyY2gtcHJvamVjdC9vcGVuc2VhcmNoJztcclxuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XHJcblxyXG5pbnRlcmZhY2UgVGV4dHJhY3RCbG9jayB7XHJcbiAgQmxvY2tUeXBlPzogc3RyaW5nO1xyXG4gIFRleHQ/OiBzdHJpbmc7XHJcbiAgQ29uZmlkZW5jZT86IG51bWJlcjtcclxuICBQYWdlPzogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgVGV4dHJhY3RSZXNwb25zZSB7XHJcbiAgSm9iU3RhdHVzPzogc3RyaW5nO1xyXG4gIFN0YXR1c01lc3NhZ2U/OiBzdHJpbmc7XHJcbiAgQmxvY2tzPzogVGV4dHJhY3RCbG9ja1tdO1xyXG59XHJcblxyXG5jb25zdCB0ZXh0cmFjdENsaWVudCA9IG5ldyBUZXh0cmFjdENsaWVudCh7fSk7XHJcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHt9KTtcclxuY29uc3Qgb3BlblNlYXJjaENsaWVudCA9IG5ldyBPcGVuU2VhcmNoQ2xpZW50KHtcclxuICBub2RlOiBwcm9jZXNzLmVudi5DT0xMRUNUSU9OX0VORFBPSU5ULFxyXG4gIHNzbDoge1xyXG4gICAgcmVqZWN0VW5hdXRob3JpemVkOiBmYWxzZVxyXG4gIH1cclxufSk7XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogUzNFdmVudCwgY29udGV4dDogQ29udGV4dCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zb2xlLmxvZygnUHJvY2Vzc2luZyBldmVudDonLCBKU09OLnN0cmluZ2lmeShldmVudCwgbnVsbCwgMikpO1xyXG5cclxuICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIGV2ZW50LlJlY29yZHMpIHtcclxuICAgICAgYXdhaXQgcHJvY2Vzc1MzUmVjb3JkKHJlY29yZCk7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHByb2Nlc3NpbmcgZXZlbnQ6JywgZXJyb3IpO1xyXG4gICAgdGhyb3cgZXJyb3I7XHJcbiAgfVxyXG59O1xyXG5cclxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc1MzUmVjb3JkKHJlY29yZDogUzNFdmVudFJlY29yZCk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGNvbnN0IGJ1Y2tldCA9IHJlY29yZC5zMy5idWNrZXQubmFtZTtcclxuICBjb25zdCBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQocmVjb3JkLnMzLm9iamVjdC5rZXkucmVwbGFjZSgvXFwrL2csICcgJykpO1xyXG5cclxuICB0cnkge1xyXG4gICAgLy8gU3RhcnQgdGV4dCBkZXRlY3Rpb25cclxuICAgIGNvbnN0IHN0YXJ0UmVzcG9uc2UgPSBhd2FpdCB0ZXh0cmFjdENsaWVudC5zZW5kKFxyXG4gICAgICBuZXcgU3RhcnREb2N1bWVudFRleHREZXRlY3Rpb25Db21tYW5kKHtcclxuICAgICAgICBEb2N1bWVudExvY2F0aW9uOiB7XHJcbiAgICAgICAgICBTM09iamVjdDoge1xyXG4gICAgICAgICAgICBCdWNrZXQ6IGJ1Y2tldCxcclxuICAgICAgICAgICAgTmFtZToga2V5XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICBpZiAoIXN0YXJ0UmVzcG9uc2UuSm9iSWQpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBKb2JJZCByZXR1cm5lZCBmcm9tIFRleHRyYWN0Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUG9sbCBmb3IgY29tcGxldGlvblxyXG4gICAgY29uc3QgdGV4dHJhY3RSZXN1bHQgPSBhd2FpdCB3YWl0Rm9yVGV4dHJhY3RDb21wbGV0aW9uKHN0YXJ0UmVzcG9uc2UuSm9iSWQpO1xyXG4gICAgXHJcbiAgICAvLyBFeHRyYWN0IHRleHQgYmxvY2tzXHJcbiAgICBjb25zdCBleHRyYWN0ZWRUZXh0ID0gdGV4dHJhY3RSZXN1bHQuQmxvY2tzXHJcbiAgICAgID8uZmlsdGVyKGJsb2NrID0+IGJsb2NrLkJsb2NrVHlwZSA9PT0gJ0xJTkUnKVxyXG4gICAgICAubWFwKGJsb2NrID0+IGJsb2NrLlRleHQpXHJcbiAgICAgIC5qb2luKCdcXG4nKSB8fCAnJztcclxuXHJcbiAgICAvLyBHZXQgb3JpZ2luYWwgZmlsZSBtZXRhZGF0YSBmcm9tIFMzXHJcbiAgICBjb25zdCBzM1Jlc3BvbnNlID0gYXdhaXQgczNDbGllbnQuc2VuZChcclxuICAgICAgbmV3IEdldE9iamVjdENvbW1hbmQoe1xyXG4gICAgICAgIEJ1Y2tldDogYnVja2V0LFxyXG4gICAgICAgIEtleToga2V5XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIC8vIFNhdmUgdG8gT3BlblNlYXJjaFxyXG4gICAgY29uc3QgZG9jdW1lbnQgPSB7XHJcbiAgICAgIGlkOiB1dWlkdjQoKSxcclxuICAgICAgdHlwZTogJ2xlYXJuaW5nX21vZHVsZScsXHJcbiAgICAgIGNvbnRlbnQ6IGV4dHJhY3RlZFRleHQsXHJcbiAgICAgIHNvdXJjZUZpbGU6IHtcclxuICAgICAgICBidWNrZXQsXHJcbiAgICAgICAga2V5LFxyXG4gICAgICAgIGxhc3RNb2RpZmllZDogczNSZXNwb25zZS5MYXN0TW9kaWZpZWQsXHJcbiAgICAgICAgY29udGVudFR5cGU6IHMzUmVzcG9uc2UuQ29udGVudFR5cGVcclxuICAgICAgfSxcclxuICAgICAgbWV0YWRhdGE6IHtcclxuICAgICAgICBwcm9jZXNzZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIGNvbmZpZGVuY2U6IGNhbGN1bGF0ZUF2ZXJhZ2VDb25maWRlbmNlKHRleHRyYWN0UmVzdWx0LkJsb2NrcyksXHJcbiAgICAgICAgcGFnZUNvdW50OiBjb3VudFBhZ2VzKHRleHRyYWN0UmVzdWx0LkJsb2NrcylcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBhd2FpdCBvcGVuU2VhcmNoQ2xpZW50LmluZGV4KHtcclxuICAgICAgaW5kZXg6IHByb2Nlc3MuZW52LkNPTExFQ1RJT05fTkFNRSB8fCAnZmlqaWFuLXRyYW5zbGF0aW9ucycsXHJcbiAgICAgIGJvZHk6IGRvY3VtZW50LFxyXG4gICAgICByZWZyZXNoOiB0cnVlXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zb2xlLmxvZyhgU3VjY2Vzc2Z1bGx5IHByb2Nlc3NlZCBhbmQgaW5kZXhlZCBkb2N1bWVudDogJHtrZXl9YCk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIHByb2Nlc3NpbmcgZmlsZSAke2tleX0gZnJvbSBidWNrZXQgJHtidWNrZXR9OmAsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvclRleHRyYWN0Q29tcGxldGlvbihqb2JJZDogc3RyaW5nLCBtYXhBdHRlbXB0cyA9IDYwKTogUHJvbWlzZTxUZXh0cmFjdFJlc3BvbnNlPiB7XHJcbiAgbGV0IGF0dGVtcHRzID0gMDtcclxuICBcclxuICB3aGlsZSAoYXR0ZW1wdHMgPCBtYXhBdHRlbXB0cykge1xyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0ZXh0cmFjdENsaWVudC5zZW5kKFxyXG4gICAgICBuZXcgR2V0RG9jdW1lbnRUZXh0RGV0ZWN0aW9uQ29tbWFuZCh7XHJcbiAgICAgICAgSm9iSWQ6IGpvYklkXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIGlmIChyZXNwb25zZS5Kb2JTdGF0dXMgPT09ICdTVUNDRUVERUQnKSB7XHJcbiAgICAgIHJldHVybiByZXNwb25zZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocmVzcG9uc2UuSm9iU3RhdHVzID09PSAnRkFJTEVEJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRleHRyYWN0IGpvYiBmYWlsZWQ6ICR7cmVzcG9uc2UuU3RhdHVzTWVzc2FnZX1gKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBXYWl0IDIgc2Vjb25kcyBiZWZvcmUgbmV4dCBhdHRlbXB0XHJcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMjAwMCkpO1xyXG4gICAgYXR0ZW1wdHMrKztcclxuICB9XHJcblxyXG4gIHRocm93IG5ldyBFcnJvcignVGV4dHJhY3QgcHJvY2Vzc2luZyB0aW1lZCBvdXQnKTtcclxufVxyXG5cclxuZnVuY3Rpb24gY2FsY3VsYXRlQXZlcmFnZUNvbmZpZGVuY2UoYmxvY2tzOiBUZXh0cmFjdEJsb2NrW10gPSBbXSk6IG51bWJlciB7XHJcbiAgY29uc3QgY29uZmlkZW5jZVZhbHVlcyA9IGJsb2Nrc1xyXG4gICAgLmZpbHRlcigoYmxvY2spOiBibG9jayBpcyBUZXh0cmFjdEJsb2NrICYgeyBDb25maWRlbmNlOiBudW1iZXIgfSA9PiBcclxuICAgICAgdHlwZW9mIGJsb2NrLkNvbmZpZGVuY2UgPT09ICdudW1iZXInXHJcbiAgICApXHJcbiAgICAubWFwKGJsb2NrID0+IGJsb2NrLkNvbmZpZGVuY2UpO1xyXG5cclxuICBpZiAoY29uZmlkZW5jZVZhbHVlcy5sZW5ndGggPT09IDApIHJldHVybiAwO1xyXG5cclxuICBjb25zdCBzdW0gPSBjb25maWRlbmNlVmFsdWVzLnJlZHVjZSgoYWNjLCB2YWwpID0+IGFjYyArIHZhbCwgMCk7XHJcbiAgcmV0dXJuIE51bWJlcigoc3VtIC8gY29uZmlkZW5jZVZhbHVlcy5sZW5ndGgpLnRvRml4ZWQoMikpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb3VudFBhZ2VzKGJsb2NrczogVGV4dHJhY3RCbG9ja1tdID0gW10pOiBudW1iZXIge1xyXG4gIHJldHVybiBuZXcgU2V0KGJsb2Nrcy5tYXAoYmxvY2sgPT4gYmxvY2suUGFnZSkpLnNpemU7XHJcbn1cclxuIl19